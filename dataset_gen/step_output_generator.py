from pathlib import Path
from typing import Callable

from models.inputs import StepsInput
from models.outputs import StepsOutput
from helpers.utils import try_json_dumps
from helpers.call_openai import call_openai_api
from dataset_gen.json_generator import JSONGenerator

DEFAULT_DUMP_DIR = Path("generated/step_output")

class StepOutputGenerator(JSONGenerator):
    def __init__(
        self,
        dump_dir: str | Path = DEFAULT_DUMP_DIR,
        file_prefix: str = "s",
        system_prompt: str = None,
        example_messages: list[dict[str, str]] = [],
        openai_func: Callable = call_openai_api,
        max_tokens: int = 4000,
        verbose: bool = True,
    ):
        system_prompt = system_prompt or (
            "You are an honest and smart assistant who can generate steps to achieve from. You don't have to actually run the functions. "
            "You just have to put them in order by using your thoughts. Your output should only be in JSON\n\n"
            'Here\'s the JSON output schema:\n{"$defs": {"ExtractEntry": {"properties": {"id": {"title": "Id", "type": "string"}, "context": {"items": {"type": "string"}, "title": "Context", "type": "array"}, "schema": {"items": {"$ref": "#/$defs/ExtractSchemaEntry"}, "title": "Schema", "type": "array"}}, "required": ["id", "context"], "title": "ExtractEntry", "type": "object"}, "ExtractSchemaEntry": {"properties": {"name": {"title": "Name", "type": "string"}, "type": {"title": "Type", "type": "string"}, "description": {"title": "Description", "type": "string"}}, "required": ["name", "type", "description"], "title": "ExtractSchemaEntry", "type": "object"}, "FunctionEntry": {"properties": {"id": {"title": "Id", "type": "string"}, "name": {"title": "Name", "type": "string"}, "parameters": {"items": {"$ref": "#/$defs/ParameterEntry"}, "title": "Parameters", "type": "array"}}, "required": ["id", "name", "parameters"], "title": "FunctionEntry", "type": "object"}, "ParameterEntry": {"properties": {"name": {"title": "Name", "type": "string"}, "value": {"anyOf": [{"type": "string"}, {"type": "integer"}, {"type": "number"}, {"items": {}, "type": "array"}, {"type": "object"}], "title": "Value"}}, "required": ["name", "value"], "title": "ParameterEntry", "type": "object"}, "Step": {"properties": {"id": {"title": "Id", "type": "string"}, "thought": {"title": "Thought", "type": "string"}, "explore_tools": {"title": "Explore Tools", "type": "string"}, "available_tools": {"items": {"type": "string"}, "title": "Available Tools", "type": "array"}, "choose_tool": {"title": "Choose Tool", "type": "string"}, "understand_dependencies": {"anyOf": [{"type": "string"}, {"type": "null"}], "default": null, "title": "Understand Dependencies"}, "extract": {"default": [], "items": {"$ref": "#/$defs/ExtractEntry"}, "title": "Extract", "type": "array"}, "function": {"items": {"$ref": "#/$defs/FunctionEntry"}, "title": "Function", "type": "array"}}, "required": ["id", "thought", "explore_tools", "available_tools", "choose_tool", "function"], "title": "Step", "type": "object"}}, "properties": {"overview": {"title": "Overview", "type": "string"}, "steps": {"items": {"$ref": "#/$defs/Step"}, "title": "Steps", "type": "array"}}, "required": ["overview", "steps"], "title": "Process", "type": "object"}'
        )
        example_messages = example_messages or [
            {
                "role": "user",
                "content": '{"query":"What are the most recent developments in AI ethics?","steps":["RESEARCH: Find the latest developments in the field of AI ethics"],"functions":[{"name":"LEGAL_DOCUMENT_RETRIEVAL","description":"Searches for and retrieves legal documents and case law based on specific criteria.","parameters":{"type":"object","properties":[{"name":"document_type","type":"string","description":"The type of legal document to be retrieved, such as \'statute\', \'case_law\', or \'regulation\'."},{"name":"jurisdiction","type":"string","description":"The jurisdiction to search within, such as \'federal\' or a specific state or country."},{"name":"keywords","type":"string","description":"Keywords or phrases related to the legal topic of interest."}],"required":["document_type"]}},{"name":"ACADEMIC_RESEARCH","description":"Searches for scholarly articles, papers, and publications in various academic fields.","parameters":{"type":"object","properties":[{"name":"query","type":"string","description":"The search query or keywords related to the academic research."},{"name":"fields_of_study","type":"array","description":"An array of academic fields to narrow down the search, such as \'computer science\', \'economics\', or \'biomedical engineering\'."},{"name":"number_of_results","type":"integer","description":"The number of research results to retrieve."},{"name":"sort_by","type":"string","description":"The criteria for sorting the search results, such as \'relevance\', \'newest\', or \'most_cited\'."}],"required":["query"]}},{"name":"POLITICS_TECH_ANALYSIS","description":"Analyzes the intersection of politics and technology, identifying trends, sentiment, and key players.","parameters":{"type":"object","properties":[{"name":"keywords","type":"array","description":"Keywords to search for in the analysis of political and technological topics."},{"name":"date_range","type":"object","properties":[{"name":"start_date","type":"string","description":"The start date for the analysis period."},{"name":"end_date","type":"string","description":"The end date for the analysis period."}],"required":["start_date","end_date"]},{"name":"sources","type":"array","description":"List of information sources to use for the analysis, such as \'news_articles\', \'social_media\', etc."}],"required":["keywords","date_range"]}},{"name":"LARGE_LANGUAGE_MODEL","description":"Interacts with a large language model to generate text, answer questions, or provide insights.","parameters":{"type":"object","properties":[{"name":"prompt","type":"string","description":"The input text or question to provide to the large language model."},{"name":"max_tokens","type":"integer","description":"The maximum number of tokens to generate in the model\'s response."},{"name":"temperature","type":"number","description":"The creativity temperature setting for the language model\'s response (typically between 0 and 1)."},{"name":"top_p","type":"number","description":"The nucleus sampling setting that controls the diversity of the response."}],"required":["prompt"]}}]}',
            },
            {
                "role": "assistant",
                "content": '{"overview":"To understand the latest developments in AI ethics, we should conduct comprehensive research across various sources, including academic papers, legal documents, and political analyses.","steps":[{"id":"step_1","thought":"We need to gather recent scholarly articles on AI ethics, relevant legal documents, and analyze the political landscape to understand the multifaceted developments in AI ethics.","explore_tools":"A combination of academic research, legal document retrieval, and political and technology analysis can provide a broad perspective on recent developments in AI ethics.","available_tools":["ACADEMIC_RESEARCH","LEGAL_DOCUMENT_RETRIEVAL","POLITICS_TECH_ANALYSIS"],"choose_tool":"The \'ACADEMIC_RESEARCH\' tool will be employed for scholarly insights; \'LEGAL_DOCUMENT_RETRIEVAL\' for understanding regulatory aspects; and \'POLITICS_TECH_ANALYSIS\' for gauging political and public sentiment regarding AI ethics.","understand_dependencies":null,"extract":[],"function":[{"id":"function_1","name":"ACADEMIC_RESEARCH","parameters":[{"name":"query","value":"AI ethics"},{"name":"fields_of_study","value":["AI ethics","computer science"]},{"name":"number_of_results","value":5},{"name":"sort_by","value":"newest"}]},{"id":"function_2","name":"LEGAL_DOCUMENT_RETRIEVAL","parameters":[{"name":"document_type","value":"regulation"},{"name":"keywords","value":"AI ethics"}]},{"id":"function_3","name":"POLITICS_TECH_ANALYSIS","parameters":[{"name":"keywords","value":["AI ethics"]},{"name":"sources","value":["news_articles"]}]}]},{"id":"step_2","thought":"\'LARGE_LANGUAGE_MODEL\' can be used for summarizing the findings from academic research, legal documents, and political analysis into a cohesive overview of recent developments in AI ethics.","explore_tools":"\'LARGE_LANGUAGE_MODEL\' provides a way to synthesize information from various sources into a comprehensive summary or answer.","available_tools":["LARGE_LANGUAGE_MODEL"],"choose_tool":"\'LARGE_LANGUAGE_MODEL\' is suitable for generating a narrative that combines all our findings into a summarized output.","understand_dependencies":null,"extract":[],"function":[{"id":"function_4","name":"LARGE_LANGUAGE_MODEL","parameters":[{"name":"prompt","value":"Summarize the latest developments in AI ethics based on recent scholarly articles, legal regulations, and political trends. Contexts: {{step_1.function.function_1}}; {{step_1.function.function_2}}; {{step_1.function.function_3}}."}]}]}]}',
            },
            {
                "role": "user",
                "content": '{"query":"What is the current temperature in the country where Elon Musk resides?","steps":["Find the country where Elon Musk resides","Find the current temperature in that country"],"functions":[{"name":"GOOGLE_SEARCH","description":"Performs a Google search and retrieves information based on the provided query.","parameters":{"type":"object","properties":[{"name":"query","type":"string","description":"The search query to be executed on Google."}],"required":["query"]}},{"name":"WEATHER_INFO","description":"Retrieves weather information based on the specified location.","parameters":{"type":"object","properties":[{"name":"location","type":"string","description":"The location for which weather information is requested. For example, \'New York, NY\'."}],"required":["location"]}},{"name":"FORMAT_TEXT","description":"Formats text with placeholders and contextual information.","parameters":{"type":"object","properties":[{"name":"context","type":"string","description":"The text to be formatted, including placeholders for function parameters."},{"name":"query","type":"string","description":"The specific query to be included in the formatted text."}],"required":["context","query"]}},{"name":"WIKIPEDIA","description":"Retrieves information from Wikipedia based on the provided search query.","parameters":{"type":"object","properties":[{"name":"query","type":"string","description":"The search query used to retrieve information from Wikipedia."}],"required":["query"]}},{"name":"GENERAL_LLM","description":"Generates natural language understanding and responses based on the provided query and context.","parameters":{"type":"object","properties":[{"name":"query","type":"string","description":"The primary query or input for the language model."},{"name":"context","type":"string","description":"Contextual information to provide additional context for the language model."}],"required":["query"]}}]}',
            },
            {
                "role": "assistant",
                "content": '{"overview":"We need to determine the current temperature in Elon Musk\'s home country. To do this, we must first identify Elon Musk\'s home country and then find out the temperature there.","steps":[{"id":"step_1","thought":"First, we need to find out Elon Musk\'s home country.","explore_tools":"To determine Elon Musk\'s home country, I have several options that can assist me.","available_tools":["GOOGLE_SEARCH","GENERAL_LLM","WIKIPEDIA"],"choose_tool":"I should choose the \'GOOGLE_SEARCH\' tool to find Elon Musk\'s home country as it uses the Google search engine to provide detailed, accurate, and trustworthy information.","understand_dependencies":null,"extract":[],"function":[{"id":"function_1","name":"GOOGLE_SEARCH","parameters":[{"name":"query","value":"What is the home country of Elon Musk?"}]}]},{"id":"step_2","thought":"Now, we need to find out the current weather in Elon Musk\'s home country.","explore_tools":"To determine the temperature of a country, I have several options that can assist me.","available_tools":["GOOGLE_SEARCH","WEATHER_INFO"],"choose_tool":"I should choose the \'WEATHER_INFO\' tool to find the temperature of Elon Musk\'s home country, as it can provide accurate and current temperature information.","understand_dependencies":"Since the \'WEATHER_INFO\' tool requires a \'location\' parameter to gather temperature details, I am dependent on the response from \'step_1.function.function_1\' to obtain the location. Therefore, I first need to extract the location from the \'step_1.function.function_1\' response.","extract":[{"id":"extract_1","context":["step_1.function.function_1"],"schema":[{"name":"country","type":"string","description":"The name of the country where Elon Musk was born or resides."}]}],"function":[{"id":"function_2","name":"WEATHER_INFO","parameters":[{"name":"location","value":"{{step_2.extract.extract_1.country}}"}]}]},{"id":"step_3","thought":"Finally, we need to format the response.","explore_tools":"To format the response, I have several options that can assist me.","available_tools":["GENERAL_LLM","FORMAT_TEXT"],"choose_tool":"I should choose the \'FORMAT_TEXT\' tool to format the response.","understand_dependencies":null,"extract":[{"id":"extract_2","context":["step_2.function.function_2"],"schema":[{"name":"temperature","type":"number","description":"The current temperature of the country."}]}],"function":[{"id":"function_3","name":"FORMAT_TEXT","parameters":[{"name":"context","value":"GOOGLE_SEARCH: <<parameters>> query: What is home country of elon musk? <<parameters>> \\\\n\\\\n Result: {{step_2.extract.extract_1.country}} \\\\n\\\\n WEATHER_INFO: <<parameters>> temperature: {{step_3.extract.extract_2.temperature}} <<parameters>>"},{"name":"query","value":"What is the current temperature in the country where Elon Musk resides?"}]}]}]}',
            },
        ]
        super().__init__(
            dump_dir,
            file_prefix,
            system_prompt,
            example_messages,
            openai_func,
            max_tokens,
            verbose,
        )

    def generate(
        self,
        step_input: StepsInput | str | dict,
        dump: bool = False,
        validate: bool = True,
        strict: bool = False,
    ):
        if isinstance(step_input, (str, dict)):
            step_input = self._to_model(step_input, StepsInput)
        if not isinstance(step_input, StepsInput):
            return None
        last_user_message = try_json_dumps(step_input.model_dump(mode="json"))
        step = self.generate_response(last_user_message, dump)
        if validate:
            step = self._validate(step, StepsOutput, strict)
        return step
